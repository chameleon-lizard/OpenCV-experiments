# Склеивалка картинок с денойзером

Хелловорлд для OpenCV. Умеет сшивать горизонтальные фото (нужен, понятное дело, оверлап) и денойзить. В папке с картинками находится две папки - исходные картинки и картинки с шумом. Шум добавлялся тупо в гимпе.

## Зависимости

```
opencv-python
argparse
imutils
numpy
```

## Использование
Три параметра:
- `-m --method` - метод денойзинга. Может быть Gaussian, Bilateral, FastNl, none.
- `-i --images` - путь к директории с картинками, которые будем сшивать.
- `-o --output` - путь к выходной картинке.

В моём примере чтобы увидеть всё, что есть, надо сделать так:
```
$ python image_stitching.py -i .\images\room_noisy -o output-denoised-FastNl.jpg -m FastNl
$ python image_stitching.py -i .\images\room_noisy -o output-denoised-Gaussian.jpg -m Gaussian
$ python image_stitching.py -i .\images\room_noisy -o output-denoised-Bilateral.jpg -m Bilateral
$ python image_stitching.py -i .\images\room_noisy -o output-noisy.jpg -m none
$ python image_stitching.py -i .\images\room_default -o output-default.jpg -m none
```
## Немного теории
Как же работает эта чудная программа? Всё просто.

Сначала мы получаем фотографии, потом создаём объект `cv2.stitcher`. Он принимает в себя фотографии, возвращает одну фотографию и результат (либо 0, то есть `OK`, либо сообщение об ошибке).

### Сшивка изображений

1) Сначала ищутся **ключевые точки**. Это делается по методу **SIFT** (*scale-invariant feature transform*). Происходит свёртка изображений **фильтрами Гаусса** (домножение каждого пикселя на матрицу), потом вычисляется разность размытых изображений. Ключевые точки - это максимумы/минимумы **разности гауссианов** (*DoG*). Это делается путём сравнения каждого пикселя по разности гауссианов изображений для её восьми соседей в том же масштабе и девяти соответствующих соседних пикселей в каждом из соседних масштабов. Если значение пикселя является максимумом или минимумом среди всех сравниваемых точек, оно выбирается как кандидат ключевой точки.
2) Происходит **локализация ключевых точек**. Соседние интерполируются, чтобы выкинуть лишние, выкидываются точки с низким контрастом (они неустойчивы к шумам), исключаются точки, не имеющие хорошо определённого местоположения, но имеющие большой вклад от рёбер потому что такие точки будут, опять же, неустойчивы к шумам.
3) **Назначается ориентация**. Смотрим на направление градиентов в локальном изображении, назначаем ориентацию ключевым точкам, добиваясь инвариантности по вращению.
4) Создаём **Дескрипторы ключевых точек**. Это нужно, чтобы наши ключевые точки были инвариантны не только относительно вращения, сдвига и изменения масштаба, а ещё и шума, освещения, точки обзора и так далее. В первую очередь создаётся набор гистограмм направлений на 4×4 соседних пикселях с 8 областями в каждой. Эти гистограммы вычисляются из значений величины и ориентации элементов в области 16×16 вокруг ключевой точки, так что каждая гистограмма содержит элементы из 4×4 подобласти исходной области соседства. Величины далее взвешиваются функцией Гаусса с сигмой равной половине ширины окна дескриптора. Дескриптор затем становится вектором всех значений этих гистограмм. Поскольку имеется 4 × 4=16 гистограмм с 8 областями в каждой, вектор имеет 128 элементов. Этот вектор нормализуется до единичной длины, чтобы обеспечить инвариантность аффинным изменениям в освещении. Чтобы сократить эффект нелинейного освещения, применяется порог величиной 0,2 и вектор снова нормализуется. 
5) Находятся **одинаковые дескрипторы** у двух изображений, эти изображения сопоставляются.
6) С помощью **RANSAC** (*RANdom SAmple Consensus*), **k-NN** (*метод k-ближайших соседей*) находится **матрица гомографии**.
7) К изображениям применяется матрица гомографии, чтобы исказить их и изображения сшиваются.

*P.S. Стоит отметить, что возможно имело бы смысл обрезать лишние части картинки, например, с помощью вычисления наибольшего прямоугольника, включающегося в получившуюся картинку после искажения и обрезания по нему. Но поскольку получившаяся картинка будет терять данные (в том числе, может терять много данных), я решил пока что на это забить. Мало ли, вдруг что то более умное в голову придёт.*